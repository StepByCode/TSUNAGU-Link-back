name: Claude PR Review

on:
  pull_request:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    # Only run when 'claude-review' label is added or @claude is mentioned
    if: |
      (github.event_name == 'pull_request' &&
       github.event.label.name == 'claude-review') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          # OAuthèªè¨¼ï¼ˆPro/Maxã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã¾ãŸã¯API Keyèªè¨¼ã‚’ã‚µãƒãƒ¼ãƒˆ
          # CLAUDE_CODE_OAUTH_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° ANTHROPIC_API_KEY ã‚’ä½¿ç”¨
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN || secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

            ## ã‚³ãƒ¼ãƒ‰å“è³ª
            - Goã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã«å¾“ã£ã¦ã„ã‚‹ã‹
            - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§
            - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            - ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆdefer, Closeç­‰ï¼‰

            ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSç­‰ã®OWASP Top 10è„†å¼±æ€§
            - èªè¨¼ãƒ»èªå¯ã®é©åˆ‡ãªå®Ÿè£…
            - æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªå–ã‚Šæ‰±ã„
            - å…¥åŠ›å€¤ã®æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

            ## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            - ä¸è¦ãªãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
            - N+1ã‚¯ã‚¨ãƒªå•é¡Œ
            - ã‚´ãƒ«ãƒ¼ãƒãƒ³ãƒªãƒ¼ã‚¯
            - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é©åˆ‡ãªä½¿ç”¨

            ## ãƒ†ã‚¹ãƒˆ
            - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ååˆ†æ€§
            - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
            - ãƒ¢ãƒƒã‚¯ã®é©åˆ‡ãªä½¿ç”¨
            - ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§

            ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            - Atlasãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ­£ç¢ºæ€§
            - schema.hclã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ•´åˆæ€§
            - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½æ€§ï¼ˆdownãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é©åˆ‡æ€§

            ## ä»•æ§˜é§†å‹•é–‹ç™ºï¼ˆSDDï¼‰
            - .kiro/specs/é…ä¸‹ã®ä»•æ§˜ã¨ã®æ•´åˆæ€§
            - è¦ä»¶ãƒ»è¨­è¨ˆãƒ»ã‚¿ã‚¹ã‚¯ã¨ã®å¯¾å¿œ
            - ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°æ–‡æ›¸(.kiro/steering/)ã¨ã®ä¸€è²«æ€§

            ## ãã®ä»–
            - å¾Œæ–¹äº’æ›æ€§ã®ç¶­æŒ
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
            - ä¸è¦ãªã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤
            - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºæ€§

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚
            é‡å¤§ãªå•é¡ŒãŒã‚ã‚Œã°æ˜ç¢ºã«æŒ‡æ‘˜ã—ã€æ”¹å–„ææ¡ˆã‚’å…·ä½“çš„ã«ç¤ºã—ã¦ãã ã•ã„ã€‚
            è‰¯ã„å®Ÿè£…ã«ã¤ã„ã¦ã‚‚ç©æ¥µçš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚

      - name: ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
        if: steps.claude-review.outcome == 'failure'
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Issue number: ${{ github.event.number }}"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "Step outcome: ${{ steps.claude-review.outcome }}"

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.claude-review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            // PRã‚¤ãƒ™ãƒ³ãƒˆã¨issue_commentã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
            const issue_number = context.payload.pull_request?.number || context.issue.number;

            console.log('Context info:', {
              event_name: context.eventName,
              issue_number: issue_number,
              has_pull_request: !!context.payload.pull_request,
              has_issue: !!context.issue
            });

            const body = `## âš ï¸ Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼

            Claudeã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ğŸ” ã‚¨ãƒ©ãƒ¼è©³ç´°
            - **å®Ÿè¡Œãƒ­ã‚°**: [Actions logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: \`${{ steps.claude-review.outcome }}\`
            - **ã‚¤ãƒ™ãƒ³ãƒˆ**: \`${{ github.event_name }}\`

            ### è€ƒãˆã‚‰ã‚Œã‚‹åŸå› 

            #### 1. èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆæœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
            - \`CLAUDE_CODE_OAUTH_TOKEN\` ã¾ãŸã¯ \`ANTHROPIC_API_KEY\` ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
            - APIã‚­ãƒ¼ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ
            - OAuth tokenã¨API keyã‚’æ··åŒã—ã¦ã„ã‚‹

            #### 2. APIåˆ¶é™
            - Anthropic APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¦ã„ã‚‹
            - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹

            #### 3. PRã‚µã‚¤ã‚º
            - PRã®å¤‰æ›´ãŒå¤§ãã™ãã‚‹å¯èƒ½æ€§

            ### âœ… å¯¾å‡¦æ–¹æ³•

            #### èªè¨¼è¨­å®šã‚’ç¢ºèª

            **æ–¹æ³•A: OAuthèªè¨¼ï¼ˆPro/Maxãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨å¥¨ï¼‰**
            \`\`\`bash
            # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
            claude setup-token
            \`\`\`
            ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»¥ä¸‹ã«è¨­å®šï¼š
            - Settings â†’ Secrets and variables â†’ Actions
            - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå: \`CLAUDE_CODE_OAUTH_TOKEN\`

            **æ–¹æ³•B: API Keyèªè¨¼**
            - [Anthropic Console](https://console.anthropic.com/)ã§APIã‚­ãƒ¼ã‚’å–å¾—
            - Settings â†’ Secrets and variables â†’ Actions
            - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå: \`ANTHROPIC_API_KEY\`
            - ã‚­ãƒ¼ã¯ \`sk-ant-\` ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

            #### è¨­å®šå¾Œã®ç¢ºèª
            1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            2. \`claude-review\` ãƒ©ãƒ™ãƒ«ã‚’ä¸€åº¦å¤–ã—ã¦å†åº¦è¿½åŠ 
            3. ã¾ãŸã¯ \`@claude\` ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§å†è©¦è¡Œ

            ### ğŸ“š è©³ç´°æƒ…å ±
            - [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](https://github.com/${{ github.repository }}/blob/main/docs/CLAUDE_CODE_SETUP.md)
            - [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](https://github.com/${{ github.repository }}/blob/main/docs/CLAUDE_CODE_SETUP.md#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

            ---
            *ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
            `;

            console.log(`Posting error comment to PR #${issue_number}`);

            try {
              const response = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: body
              });
              console.log(`Comment posted successfully: ${response.data.html_url}`);
            } catch (error) {
              console.error(`Failed to post comment: ${error.message}`);
              throw error;
            }
